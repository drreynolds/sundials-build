#!/bin/bash -e
#
# This file contains installation locations for various SUNDIALS
# dependencies on different computers.  Each value will be
# optionally set based on the following priorities:
#
# 1. Env. var. for specific option:
#
#       SUNINDEXTYPE -- "64" or "32"
#       SUNREALTYPE -- "single", "double" or "extended"
#       SUNBUILDTYPE -- "OPT" or "DBG"
#       SUNOPTFLAGS -- specific optimization flags to use
#       SUNINSTALLPREFIX -- desired installation location
#       SUNEXAMPLEPREFIX -- desired example install location
#       MPIDIR -- MPI installation location
#       KLUDIR -- KLU installation location
#       LAPACKLIB -- LAPACK libraries (e.g., -L/usr/lib -llapack)
#       HYPREDIR -- HYPRE installation location
#       PETSCDIR -- PETSc installation location
#       MAGMADIR -- MAGMA installation location
#       CUDADIR -- CUDA installation location
#       CUDAARCH -- CUDA architecture
#       RAJADIR -- RAJA installation location
#       GENERATEANSWERS -- generate/use machine-specific test 'answers'
#             1 -> generate 'answers', place in HOST_ANSWERS
#             0 -> use answers in HOST_ANSWERS [default]
#            -1 -> use repository answers
#
# 2. Default values for specific hosts (hard-coded in this file); the
#    hostname is either set by the environment variable HOST, or
#    is obtained by calling the 'hostname' command
#
# 3. Default Spack installation locations
#
# 4. Default values
#
# Daniel R. Reynolds
# SMU Mathematics

# determine machine "name" based on 'HOST' environment variable, or
# if that is unset, then via the shell 'hostname' command
HOST=${HOST:-`hostname`}

# set index type (or use default)
SUNINDEXTYPE=${SUNINDEXTYPE:-"64"}

# set real type (or use default)
SUNREALTYPE=${SUNREALTYPE:-"double"}

# set build type (or use default)
SUNBUILDTYPE=${SUNBUILDTYPE:-"OPT"}

# set hostname-specific defaults
if [ $HOST == "Longclaw" ]
then

  HOST_ANSWERS=/home/drreynolds/research/Sundials/local_answers
  HOST_MPIDIR=/usr/local/mpich-3.3.2
  HOST_KLUDIR=
  HOST_HYPREDIR=
  if [ $SUNREALTYPE == "double" ]
  then
    HOST_KLUDIR=/usr/local/suite-sparse-5.3.0
    HOST_HYPREDIR=/usr/local/hypre-2.20.0
  fi
  HOST_LAPACKLIB=
  HOST_SLUDISTDIR=
  HOST_MAGMADIR=
  HOST_PETSCDIR=
  if [ $SUNINDEXTYPE == "32" ]
  then
    if [ $SUNREALTYPE == "double" ]
    then
      HOST_PETSCDIR=/usr/local/petsc-3.14.1
    fi
  fi
  HOST_CUDADIR=/usr/local/cuda
  HOST_CUDAARCH=61
  HOST_RAJADIR=/usr/local/raja-0.12.1
  HOST_OPENMPFLAG=-fopenmp

elif [ $HOST == "behemoth" ]
then

  HOST_ANSWERS=/home/dreynolds/research/Sundials/local_answers
  # HOST_MPIDIR=/usr/local/mpich-3.3.2/gcc-10.2
  # HOST_KLUDIR=/usr/local/suite-sparse-5.8.1/gcc-10.2
  # HOST_HYPREDIR=/usr/local/hypre-2.20.0/gcc-10.2
  # HOST_LAPACKLIB=/usr/local/openblas-0.3.12/gcc-10.2/lib/libopenblas.a
  HOST_MPIDIR=/usr/local/mpich-3.3.2/gcc-7.5.0
  HOST_KLUDIR=/usr/local/suite-sparse-5.8.1/gcc-7.5.0
  HOST_HYPREDIR=/usr/local/hypre-2.20.0/gcc-7.5.0
  HOST_LAPACKLIB=/usr/local/openblas-0.3.12/gcc-7.5.0/lib/libopenblas.a
  HOST_PETSCDIR=
  HOST_SLUDISTDIR=
  if [ $SUNINDEXTYPE == "32" ]
  then
      HOST_MAGMADIR=/usr/local/magma-2.6.1
  else
      HOST_MAGMADIR=
  fi
  HOST_CUDADIR=/usr/local/cuda
  HOST_CUDAARCH=61
  # HOST_RAJADIR=/usr/local/raja-0.12.1/gcc-10.2
  HOST_RAJADIR=/usr/local/raja-0.12.1/gcc-7.5.0
  HOST_OPENMPFLAG=-fopenmp

elif [ $HOST == "cauchy" ]
then

  HOST_ANSWERS=/home/dreynolds/research/Sundials/local_answers
  HOST_MPIDIR=/usr/local/mpich-3.3.2/gcc-9.3.0
  HOST_KLUDIR=/usr/local/suite-sparse-5.8.1/gcc-9.3.0
  HOST_HYPREDIR=/usr/local/hypre-2.20.0/gcc-9.3.0
  if [ $SUNINDEXTYPE == "32" ]
  then
      HOST_MAGMADIR=/usr/local/magma-2.6.1/gcc-9.3.0
  else
      HOST_MAGMADIR=
  fi
  HOST_SLUDISTDIR=
  HOST_LAPACKLIB=/usr/local/openblas-0.3.12/gcc-9.3.0/lib/libopenblas.a
  HOST_PETSCDIR=
  HOST_CUDADIR=/usr/local/cuda
  HOST_CUDAARCH=61
  HOST_RAJADIR=/usr/local/raja-0.12.1/gcc-9.3.0
  HOST_OPENMPFLAG=-fopenmp

elif [ $HOST == "dirac" ]
then

  HOST_ANSWERS=/home/dreynolds/research/Sundials/local_answers
  HOST_MPIDIR=/usr/local/mpich-3.3.2
  HOST_KLUDIR=/usr/local/suite-sparse-5.3.0
  HOST_HYPREDIR=/usr/local/hypre-2.20.0
  if [ $SUNINDEXTYPE == "32" ]
  then
      HOST_MAGMADIR=/usr/local/magma-2.6.1
  else
      HOST_MAGMADIR=
  fi
  HOST_LAPACKLIB=/usr/local/openblas-0.3.12/lib/libopenblas.a
  HOST_SLUDISTDIR=
  HOST_PETSCDIR=
  HOST_CUDADIR=/usr/local/cuda
  HOST_CUDAARCH=61
  HOST_RAJADIR=/usr/local/raja-0.12.1
  HOST_OPENMPFLAG=-fopenmp

elif [ $HOST == "descartes" ]
then

  HOST_ANSWERS=/Users/dreynolds/research/Sundials/local_answers
  HOST_MPIDIR=/usr/local/mpich-3.3.2
  HOST_KLUDIR=/usr/local/suite-sparse-5.8.1
  HOST_HYPREDIR=/usr/local/hypre-2.20.0
  HOST_LAPACKLIB=
  HOST_PETSCDIR=
  HOST_MAGMADIR=
  # if [ $SUNBUILDTYPE == "OPT" ]
  # then
  #     SUNOPTFLAGS="${SUNOPTFLAGS} -Wno-alloc-size-larger-than -O3"
  # else
  #     SUNOPTFLAGS="${SUNOPTFLAGS} -Wno-alloc-size-larger-than -O0 -g"
  # fi
  HOST_SLUDISTDIR=
  HOST_OPENMPFLAG=-fopenmp

elif [ $HOST == "asymptote" ]
then

  HOST_ANSWERS=/Users/dreynolds/research/Sundials/local_answers
  HOST_MPIDIR=/opt/local/openmpi-4.1.3
  HOST_KLUDIR=/opt/local/suite-sparse-5.12.0
  HOST_HYPREDIR=/opt/local/hypre-2.24.0
  HOST_LAPACKLIB=
  if [ $SUNINDEXTYPE == "32" ]
  then
      HOST_PETSCDIR=/opt/local/petsc-3.17.0
  else
      HOST_PETSCDIR=
  fi
  HOST_MAGMADIR=
  HOST_SLUDISTDIR=
  HOST_CUDADIR=
  HOST_CUDAARCH=
  HOST_RAJADIR=
  HOST_OPENMPFLAG=-fopenmp
  export OMPI_CC=/opt/homebrew/bin/gcc-11
  export OMPI_CXX=/opt/homebrew/bin/g++-11
  export OMPI_FC=/opt/homebrew/bin/gfortran-11

elif [ $HOST == "maneframe2" ]
then

  HOST_ANSWERS=/users/reynolds/research/sundials/local_answers
  HOST_MPIDIR=/hpc/applications/hpc-x/hpcx-v2.1.0/gcc-7.3/hpcx-ompi/
  HOST_KLUDIR=
  HOST_HYPREDIR=
  HOST_LAPACKLIB=
  HOST_PETSCDIR=
  HOST_SLUDISTDIR=
  HOST_MAGMADIR=
  #HOST_CUDADIR=/users/reynolds/sw/cuda-11.3.0
  #HOST_CUDAARCH=60
  #HOST_RAJADIR=/users/reynolds/sw/raja-0.13.0
  HOST_CUDADIR=
  HOST_CUDAARCH=
  HOST_RAJADIR=
  HOST_OPENMPFLAG=

else

  # check if Spack is installed, and get values from there
  if [ spack location -i mpich ];
  then
    HOST_MPIDIR=`spack location -i mpich`
  elif [ spack location -i openmpi ]
  then
    HOST_MPIDIR=`spack location -i openmpi`
  else
    HOST_MPIDIR=/usr
  fi
  if [ spack location -i suite-sparse ];
  then
    HOST_KLUDIR=`spack location -i suite-sparse`
  else
    HOST_KLUDIR=
  fi
  if [ spack location -i openblas ];
  then
    OBDIR=`spack location -i openblas`
    HOST_LAPACKLIB="-L${OBDIR}/lib -lopenblas"
  else
    HOST_LAPACKLIB=
  fi
  if [ spack location -i hypre ];
  then
    HOST_HYPREDIR=`spack location -i hypre`
  else
    HOST_HYPREDIR=
  fi
  if [ spack location -i petsc ];
  then
    HOST_PETSCDIR=`spack location -i petsc`
  else
    HOST_PETSCDIR=
  fi
  if [ spack location -i superlu-dist ];
  then
    HOST_SLUDISTDIR=`spack location -i superlu-dist`
  else
    HOST_SLUDISTDIR=
  fi
  if [ spack location -i cuda ];
  then
    HOST_CUDADIR=`spack location -i cuda`
    HOST_CUDAARCH=61
  else
    HOST_CUDADIR=
    HOST_CUDAARCH=
  fi
  if [ spack location -i magma ];
  then
    HOST_MAGMADIR=`spack location -i magma`
  else
    HOST_MAGMADIR=
  fi
  if [ spack location -i raja ];
  then
    HOST_RAJADIR=`spack location -i raja`
  else
    HOST_RAJADIR=
  fi
  HOST_OPENMPFLAG=

fi


# set installation paths based on build options
SUNBUILDTYPE=${SUNBUILDTYPE:-"OPT"}
ANSWERS=${HOST_ANSWERS:-"$PWD/../local_answers"}
if [ $SUNBUILDTYPE == "OPT" ]
then
  SUNINSTALLPREFIX=${SUNINSTALLPREFIX:-"$PWD/../install_opt"}
  SUNEXAMPLEPREFIX=${SUNEXAMPLEPREFIX:-"$PWD/../examples_opt"}
  SUNOPTFLAGS=${SUNOPTFLAGS:-"-O3"}
else
  SUNINSTALLPREFIX=${SUNINSTALLPREFIX:-"$PWD/../install_dbg"}
  SUNEXAMPLEPREFIX=${SUNEXAMPLEPREFIX:-"$PWD/../examples_dbg"}
  SUNOPTFLAGS=${SUNOPTFLAGS:-"-O0 -g"}
fi

# set final build variables based on environment or defaults above
MPIDIR=${MPIDIR:-${HOST_MPIDIR}}
KLUDIR=${KLUDIR:-${HOST_KLUDIR}}
LAPACKLIB=${LAPACKLIB:-${HOST_LAPACKLIB}}
HYPREDIR=${HYPREDIR:-${HOST_HYPREDIR}}
PETSCDIR=${PETSCDIR:-${HOST_PETSCDIR}}
SLUDISTDIR=${SLUDISTDIR:-${HOST_SLUDISTDIR}}
MAGMADIR=${MAGMADIR:-${HOST_MAGMADIR}}
CUDADIR=${CUDADIR:-${HOST_CUDADIR}}
CUDAARCH=${CUDAARCH:-${HOST_CUDAARCH}}
RAJADIR=${RAJADIR:-${HOST_RAJADIR}}
OPENMPFLAG=${OPENMPFLAG:-${HOST_OPENMPFLAG}}
GENERATEANSWERS=${GENERATEANSWERS:-"0"}

# output final build configuration setup
echo "Compiling SUNDIALS on host: $HOST"
echo "  build type: $SUNBUILDTYPE"
echo "  index size: $SUNINDEXTYPE"
echo "  realtype: $SUNREALTYPE"
echo "  installation location: $SUNINSTALLPREFIX"
echo "  example location: $SUNEXAMPLEPREFIX"
if [ ! $GENERATEANSWERS == "-1" ]
then
  echo "  'answers' location: $ANSWERS"
  echo "  generating answers: $GENERATEANSWERS"
fi
echo "  optimization flags: $SUNOPTFLAGS"
echo "  MPI libraries: $MPIDIR"
echo "  OpenMP flag: $OPENMPFLAG"
echo "  KLU libraries: $KLUDIR"
echo "  LAPACK libraries: $LAPACKLIB"
echo "  HYPRE libraries: $HYPREDIR"
echo "  PETSC libraries: $PETSCDIR"
echo "  SuperLU-Dist libraries: $SLUDISTDIR"
echo "  MAGMA libraries: $MAGMADIR"
echo "  CUDA install location: $CUDADIR"
echo "  CUDA architecture: $CUDAARCH"
echo "  RAJA libraries: $RAJADIR"

####### End of machines.in #######
