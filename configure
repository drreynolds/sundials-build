#!/bin/bash

# clean from any previous build
./cleanup

# source machines file
source machines.in

# set source directory based on command-line argument (if specified)
if [ -n "$1" ]
then
    SRCDIR=$1
else
    SRCDIR=../develop
fi
echo "  "
echo "Configuring SUNDIALS from source code in $SRCDIR"
echo "  "

# optionally build with PETSc
if [[ ! -z "$PETSCDIR" ]]
then
  PETSC_CONF=" -DPETSC_ENABLE:BOOL=1 -DPETSC_DIR:STRING=$PETSCDIR"
  export LD_LIBRARY_PATH=$LD_LIBRARY_PATH:$PETSCDIR/lib
else
  PETSC_CONF=" -DPETSC_ENABLE:BOOL=0"
fi

# optionally build with HYPRE
if [[ ! -z "$HYPREDIR" ]]
then
  HYPRE_CONF=" -DHYPRE_ENABLE:BOOL=1 -DHYPRE_INCLUDE_DIR:STRING=$HYPREDIR/include -DHYPRE_LIBRARY_DIR:FILEPATH=$HYPREDIR/lib"
else
  HYPRE_CONF=" -DHYPRE_ENABLE:BOOL=0"
fi

# optionally build with KLU
if [[ ! -z "$KLUDIR" ]]
then
  KLU_CONF=" -DKLU_ENABLE:BOOL=1 -DKLU_INCLUDE_DIR:STRING=$KLUDIR/include -DKLU_LIBRARY_DIR:FILEPATH=$KLUDIR/lib"
else
  KLU_CONF=" -DKLU_ENABLE:BOOL=0"
fi

# optionally build with LAPACK
if [[ ! -z "$LAPACKLIB" ]]
then
  LAPACK_CONF=" -DLAPACK_ENABLE:BOOL=1 -DLAPACK_LIBRARIES:FILEPATH=$LAPACKLIB"
else
  LAPACK_CONF=" -DLAPACK_ENABLE:BOOL=0"
fi

# optionally build with SuperLU-Dist
if [[ ! -z "$SLUDISTDIR" ]]
then
  SLUDIST_CONF=" -DSUPERLUDIST_ENABLE:BOOL=1 -DSUPERLUDIST_INCLUDE_DIR:STRING=$SLUDISTDIR/include -DSUPERLUDIST_LIBRARY_DIR:FILEPATH=$SLUDISTDIR/lib -DSUPERLUDIST_LIBRARIES=$SLUDISTDIR/lib/libopenblas.a;$SLUDISTDIR/lib/libparmetis.a;$SLUDISTDIR/lib/libmetis.a"
else
  SLUDIST_CONF=" -DSUPERLUDIST_ENABLE:BOOL=0"
fi

# cmake command
cmake \
 -DCMAKE_INSTALL_PREFIX:PATH=$SUNINSTALLPREFIX \
 -DEXAMPLES_INSTALL_PATH:PATH=$SUNEXAMPLEPREFIX \
 -DCMAKE_C_COMPILER=$MPIDIR/bin/mpicc \
 -DMPI_C_COMPILER=$MPIDIR/bin/mpicc \
 -DCMAKE_Fortran_COMPILER=$MPIDIR/bin/mpif90 \
 -DMPI_Fortran_COMPILER=$MPIDIR/bin/mpif90 \
 -DCMAKE_CXX_COMPILER=$MPIDIR/bin/mpicxx \
 -DMPI_CXX_COMPILER=$MPIDIR/bin/mpicxx \
 -DMPIEXEC_EXECUTABLE=$MPIDIR/bin/mpiexec \
 -DCMAKE_MACOSX_RPATH=ON \
 -DCMAKE_C_FLAGS:STRING="$SUNOPTFLAGS -fPIC -std=c99 -Wall -Wpedantic -Werror" \
 -DCMAKE_Fortran_FLAGS:STRING="$SUNOPTFLAGS -fPIC -Wall -Wpedantic -ffpe-summary=none" \
 -DCMAKE_CXX_FLAGS:STRING="$SUNOPTFLAGS -fPIC -std=c++11 -Wall -Wpedantic -Werror" \
 -DOpenMP_C_FLAGS:STRING="-fopenmp" \
 -DOpenMP_CXX_FLAGS:STRING="-fopenmp" \
 -DSUNDIALS_PRECISION:STRING=$SUNREALTYPE \
 -DSUNDIALS_INDEX_SIZE:STRING=$SUNINDEXTYPE \
 -DEXAMPLES_ENABLE_C:BOOL=1 \
 -DEXAMPLES_ENABLE_CXX:BOOL=1 \
 -DEXAMPLES_ENABLE_F90:BOOL=1 \
 -DEXAMPLES_INSTALL:BOOL=1 \
 -DSUNDIALS_TEST_DEVTESTS=ON \
 -DSUNDIALS_TEST_UNITTESTS=ON \
 -DF77_INTERFACE_ENABLE:BOOL=1 \
 -DF2003_INTERFACE_ENABLE:BOOL=1 \
 -DMPI_ENABLE:BOOL=1 \
 -DOPENMP_ENABLE:BOOL=1 \
 -DPTHREAD_ENABLE:BOOL=1 \
 -DBUILD_SHARED_LIBS:BOOL=1 \
 $LAPACK_CONF \
 $KLU_CONF \
 $HYPRE_CONF \
 $PETSC_CONF \
 $SLUDIST_CONF \
 $SRCDIR
